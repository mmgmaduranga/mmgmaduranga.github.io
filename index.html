<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Population-Fertility-Life Expectancy Story</title>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; }
    svg { margin-top: 20px; }
    .annotation { font-size: 12px; fill: #333; }
    #controls { margin: 20px; }
  </style>
</head>
<body>
  <h1>Global Trends: Fertility, Life Expectancy, Population</h1>
  <div id="controls">
    <button id="prev">Previous</button>
    <button id="next">Next</button>
    <label for="country">Country:</label>
    <select id="country"></select>
  </div>
  <svg width="700" height="500"></svg>

  <script>
    const margin = {top: 40, right: 40, bottom: 40, left: 60},
          width = 700 - margin.left - margin.right,
          height = 500 - margin.top - margin.bottom;

    const svg = d3.select("svg")
      .append("g")
      .attr("transform", `translate(${margin.left},${margin.top})`);

    let sceneIndex = 0;
    let scenes = [scene1, scene2, scene3];

    let selectedCountry = "India";

    d3.csv("world_population_data.csv").then(data => {
      data.forEach(d => {
        d.year = +d.year;
        d.population = +d.population;
        d.fertility_rate = +d.fertility_rate;
        d.life_expectancy = +d.life_expectancy;
      });

      const countries = Array.from(new Set(data.map(d => d.country)));
      countries.forEach(c => d3.select("#country").append("option").text(c));

      d3.select("#country").on("change", function() {
        selectedCountry = this.value;
        updateScene();
      });

      d3.select("#next").on("click", () => {
        sceneIndex = Math.min(sceneIndex + 1, scenes.length - 1);
        updateScene();
      });

      d3.select("#prev").on("click", () => {
        sceneIndex = Math.max(sceneIndex - 1, 0);
        updateScene();
      });

      function updateScene() {
        svg.selectAll("*").remove();
        scenes[sceneIndex](data);
      }

      function scene1(data) {
        // Static scatterplot for year 2000
        const filtered = data.filter(d => d.year === 2000);
        const x = d3.scaleLinear().domain([0, 8]).range([0, width]);
        const y = d3.scaleLinear().domain([30, 90]).range([height, 0]);
        const r = d3.scaleSqrt().domain([0, d3.max(data, d => d.population)]).range([2, 30]);

        svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x));
        svg.append("g").call(d3.axisLeft(y));

        svg.selectAll("circle")
          .data(filtered)
          .enter()
          .append("circle")
          .attr("cx", d => x(d.fertility_rate))
          .attr("cy", d => y(d.life_expectancy))
          .attr("r", d => r(d.population))
          .attr("fill", "steelblue")
          .append("title").text(d => `${d.country}\nPopulation: ${d.population}`);
      }

      function scene2(data) {
        // Animated scatterplot
        let year = 1960;
        const x = d3.scaleLinear().domain([0, 8]).range([0, width]);
        const y = d3.scaleLinear().domain([30, 90]).range([height, 0]);
        const r = d3.scaleSqrt().domain([0, d3.max(data, d => d.population)]).range([2, 30]);

        svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x));
        svg.append("g").call(d3.axisLeft(y));

        const yearLabel = svg.append("text")
          .attr("x", width - 100)
          .attr("y", height - 10)
          .style("font-size", "16px")
          .text(year);

        const dots = svg.selectAll("circle").data(data.filter(d => d.year === year))
          .enter().append("circle")
          .attr("cx", d => x(d.fertility_rate))
          .attr("cy", d => y(d.life_expectancy))
          .attr("r", d => r(d.population))
          .attr("fill", "steelblue")
          .append("title").text(d => d.country);

        const interval = d3.interval(() => {
          year += 1;
          if (year > 2020) interval.stop();
          const frameData = data.filter(d => d.year === year);
          svg.selectAll("circle")
            .data(frameData)
            .join("circle")
            .attr("cx", d => x(d.fertility_rate))
            .attr("cy", d => y(d.life_expectancy))
            .attr("r", d => r(d.population))
            .attr("fill", "steelblue");
          yearLabel.text(year);
        }, 500);
      }

      function scene3(data) {
        // Line chart for selected country
        const countryData = data.filter(d => d.country === selectedCountry);
        const x = d3.scaleLinear().domain(d3.extent(countryData, d => d.year)).range([0, width]);
        const y = d3.scaleLinear().domain([0, d3.max(countryData, d => Math.max(d.fertility_rate, d.life_expectancy))]).range([height, 0]);

        svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x));
        svg.append("g").call(d3.axisLeft(y));

        const line = (metric, color) => {
          svg.append("path")
            .datum(countryData)
            .attr("fill", "none")
            .attr("stroke", color)
            .attr("stroke-width", 2)
            .attr("d", d3.line()
              .x(d => x(d.year))
              .y(d => y(d[metric])));
        };

        line("fertility_rate", "orange");
        line("life_expectancy", "green");
      }

      updateScene();
    });
  </script>
</body>
</html>